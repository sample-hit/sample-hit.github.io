<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Luau Obfuscator</title>
    <script src="https://cdn.jsdelivr.net/npm/luaparse@0.3.1/luaparse.min.js"></script>
    <style>
        :root {
            --bg: #0d1117;
            --accent: #58a6ff;
            --text: #c9d1d9;
            --panel: #161b22;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container { width: 90%; max-width: 1000px; }
        .editor-header { padding: 10px; background: var(--panel); border-radius: 8px 8px 0 0; border: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center;}
        textarea {
            width: 100%;
            height: 300px;
            background: #010409;
            color: #7ee787;
            border: 1px solid #30363d;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace;
            resize: vertical;
        }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        button {
            padding: 10px 20px;
            background-color: #238636;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        button:hover { background-color: #2ea043; }
        button.secondary { background-color: #30363d; }
        button.secondary:hover { background-color: #8b949e; }
        .status { margin-top: 10px; font-size: 0.9em; color: var(--accent); }
    </style>
</head>
<body>

    <div class="container">
        <h1>Luau Obfuscator</h1>
        <p>Wraps code in a Virtualization Layer (API Hooking style).</p>

        <div class="editor-header">
            <span>Input Code</span>
        </div>
        <textarea id="input" placeholder="-- Paste your code here...&#10;print('Hello World')"></textarea>

        <div class="controls">
            <button onclick="obfuscate()">Obfuscate</button>
            <button class="secondary" onclick="copyToClipboard()">Copy Result</button>
            <button class="secondary" onclick="downloadTxt()">Download .txt</button>
        </div>

        <div class="editor-header">
            <span>Output (Obfuscated)</span>
        </div>
        <textarea id="output" readonly placeholder="Obfuscated code will appear here..."></textarea>
        <div id="status" class="status"></div>
    </div>

    <script>
        // This is the "VM" Header that defines how the hooked code runs
        const VM_HEADER = `-- Obfuscated by Web-Unparser\nlocal _VM = {CALL = function(f, ...) return f(...) end}\n`;

        function obfuscate() {
            const input = document.getElementById('input').value;
            const status = document.getElementById('status');
            
            try {
                const ast = luaparse.parse(input);
                status.innerText = "Parsing successful. Rebuilding AST...";
                
                // Process the AST nodes just like your Luau script did
                let outputCode = VM_HEADER;
                outputCode += processBody(ast.body);
                
                document.getElementById('output').value = outputCode;
                status.innerText = "Done! Code has been hooked.";
            } catch (e) {
                status.innerText = "Error: " + e.message;
            }
        }

        function processBody(body) {
            return body.map(node => unparse(node)).join('\n');
        }

        function unparse(node) {
            if (!node) return '';

            switch (node.type) {
                case 'CallStatement':
                    return unparse(node.expression);

                case 'CallExpression':
                    const base = unparse(node.base);
                    const args = node.arguments.map(arg => unparse(arg)).join(', ');
                    // This is the "Hooking" logic
                    return `_VM.CALL(${base}${args ? ', ' + args : ''})`;

                case 'Identifier':
                    return node.name;

                case 'StringLiteral':
                    // Convert strings to Hex so they aren't readable
                    return '"' + node.value.split('').map(c => 
                        '\\' + c.charCodeAt(0)
                    ).join('') + '"';

                case 'NumericLiteral':
                    return node.value;

                case 'FunctionDeclaration':
                    const name = unparse(node.identifier);
                    const params = node.parameters.map(p => p.name).join(', ');
                    const fBody = processBody(node.body);
                    return `function ${name}(${params})\n${fBody}\nend`;

                case 'LocalStatement':
                    const vars = node.variables.map(v => v.name).join(', ');
                    const init = node.init.map(i => unparse(i)).join(', ');
                    return `local ${vars} = ${init}`;

                case 'AssignmentStatement':
                    const left = node.variables.map(v => unparse(v)).join(', ');
                    const right = node.init.map(i => unparse(i)).join(', ');
                    return `${left} = ${right}`;

                default:
                    return `-- [[ Unknown Node Type: ${node.type} ]]`;
            }
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            output.select();
            document.execCommand('copy');
            alert("Copied to clipboard!");
        }

        function downloadTxt() {
            const text = document.getElementById('output').value;
            const blob = new Blob([text], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.download = "obfuscated.txt";
            anchor.href = (window.webkitURL || window.URL).createObjectURL(blob);
            anchor.click();
        }
    </script>
</body>
</html>
